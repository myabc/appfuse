<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="UserSQL">

    <typeAlias alias="user" type="org.appfuse.model.User"/>
    <typeAlias alias="userCookie" type="org.appfuse.model.UserCookie"/>
    <typeAlias alias="userRole" type="org.appfuse.model.UserRole"/>
    
    <resultMap id="userResult" class="user">
        <result property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="address.address" column="address"/>
        <result property="address.city" column="city"/>
        <result property="address.province" column="province"/>
        <result property="address.country" column="country"/>
        <result property="address.postalCode" column="postal_code"/>
        <result property="email" column="email"/>
    </resultMap>

	<insert id="addUser" parameterClass="user">
    <![CDATA[
        INSERT INTO 
        app_user (id, username, password, first_name, last_name, address, 
                  city, province, country, postal_code, email, phone_number, 
                  website, passwordHint)
        VALUES (#id#, #username#, #password#, #firstName#, #lastName#, 
                #address.address#, #address.city#, #address.province#,
                #address.country#, #address.postalCode#, #email#, #phoneNumber#,
                #website#, #passwordHint#);
    ]]>
    </insert>
    
	<select id="getUserId" resultClass="java.lang.Long">
    <![CDATA[
        SELECT max(id) from app_user;
    ]]>
    </select>
    
	<insert id="addUserRole">
    <![CDATA[
        INSERT INTO 
            user_role (id, user_id, username, role_name)
        VALUES (#id#, #userId#, #username#, #roleName#);
    ]]>
    </insert>
    
	<select id="getRoleId" resultClass="java.lang.Long">
    <![CDATA[
        SELECT max(id) from user_role;
    ]]>
    </select>
    
	<update id="updateUser" parameterClass="user">
    <![CDATA[
        UPDATE app_user SET
            username = #username#,
            password = #password#,
            first_name = #firstName#,
            last_name = #lastName#,
            address = #address.address#,
            city = #address.city#,
            province = #address.province#,
            country = #address.country#,
            postal_code = #address.postalCode#,
            email = #email#,
            phone_number = #phoneNumber#,
            website = #website#,
            passwordHint = #passwordHint#
        WHERE id = #id#;
    ]]>
    </update>
    
	<select id="getUser" resultMap="userResult" resultClass="user">
    <![CDATA[
        SELECT * FROM app_user WHERE username=#username#;
    ]]>
    </select>
    
	<select id="getUsers" resultMap="userResult" resultClass="user">
    <![CDATA[
        SELECT * FROM app_user ORDER BY UPPER(username);
    ]]>
    </select>
    
	<select id="getUserRoles" resultClass="userRole">
    <![CDATA[
        SELECTid, role_name as roleName, user_id as userId, username
        FROM user_role WHERE username=#username#;
    ]]>
    </select>
    
	<delete id="deleteUser">
    <![CDATA[
        DELETE FROM app_user where username = #username#;
    ]]>
    </delete>
    
	<delete id="deleteUserRoles">
    <![CDATA[
        DELETE FROM user_role WHERE username = #username#;
    ]]>
    </delete>
    
	<select id="getUserCookies" resultClass="userCookie">
    <![CDATA[
        SELECT id, username, cookie_id as cookieId, date_created as dateCreated
        FROM user_cookie where cookie_id = #cookieId#;
    ]]>
    </select>
    
	<delete id="deleteUserCookies">
    <![CDATA[
        DELETE FROM user_cookie where username = #username#;
    ]]>
    </delete>
    
	<insert id="addUserCookie" parameterClass="userCookie">
    <![CDATA[
        INSERT INTO 
            user_cookie (id, username, cookie_id, date_created)
        VALUES (#id#, #username#, #cookieId#, #dateCreated#);
    ]]>
  </insert>
    
	<select id="getUserCookieId" resultClass="java.lang.Long">
    <![CDATA[
        SELECT max(id) FROM user_cookie;
    ]]>
  </select>
    
	<update id="updateUserCookie" parameterClass="userCookie">
    <![CDATA[
        UPDATE user_cookie SET
            username = #username#,
            cookie_id = #cookieId#,
            date_created = #dateCreated#
        WHERE id = #id#;
    ]]>
  </update>
</sqlMap>
