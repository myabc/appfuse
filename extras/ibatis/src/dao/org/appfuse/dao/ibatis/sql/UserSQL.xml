<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
    "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="UserSQL">

    <typeAlias alias="user" type="org.appfuse.model.User"/>
    <typeAlias alias="userCookie" type="org.appfuse.model.UserCookie"/>
    
    <resultMap id="userResult" class="user">
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="address.address" column="address"/>
        <result property="address.city" column="city"/>
        <result property="address.province" column="province"/>
        <result property="address.country" column="country"/>
        <result property="address.postalCode" column="postal_code"/>
        <result property="email" column="email"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="website" column="website"/>
        <result property="passwordHint" column="password_hint"/>
        <result property="updated" column="updated"/>
    </resultMap>
    
	<insert id="addUser" parameterClass="user">
    <![CDATA[
        insert into 
        app_user (username, password, first_name, last_name, address, 
                  city, province, country, postal_code, email, phone_number, 
                  website, password_hint, updated)
        values (#username#, #password#, #firstName#, #lastName#, 
                #address.address#, #address.city#, #address.province#,
                #address.country#, #address.postalCode#, #email#, #phoneNumber#,
                #website#, #passwordHint#, #updated#);
    ]]>
    </insert>
    
	<insert id="addUserRole" parameterClass="map">
    <![CDATA[
        insert into user_role (username, role_name)
        values (#username#, #roleName#);
    ]]>
    </insert>
    
	<update id="updateUser" parameterClass="user">
    <![CDATA[
        update app_user SET
            password = #password#,
            first_name = #firstName#,
            last_name = #lastName#,
            address = #address.address#,
            city = #address.city#,
            province = #address.province#,
            country = #address.country#,
            postal_code = #address.postalCode#,
            email = #email#,
            phone_number = #phoneNumber#,
            website = #website#,
            password_hint = #passwordHint#,
            updated = #updated#
        where username = #username#;
    ]]>
    </update>
    
	<select id="getUser" resultMap="userResult">
    <![CDATA[
        select * from app_user where username=#username#;
    ]]>
    </select>
    
	<select id="getUsers" resultMap="userResult">
    <![CDATA[
        select * from app_user ORDER BY UPPER(username);
    ]]>
    </select>
    
	<select id="getUserRoles" resultClass="role">
    <![CDATA[
        select user_role.role_name as name, role.description, role.updated
        from user_role left join role on role.name = user_role.role_name
        where user_role.username=#username#;
    ]]>
    </select>
    
	<delete id="deleteUser" parameterClass="user">
    <![CDATA[
        delete from app_user where username = #username#;
    ]]>
    </delete>
    
    <delete id="deleteUserRoles" parameterClass="user">
    <![CDATA[
        delete from user_role where username = #username#;
    ]]>
    </delete>
    
	<select id="getUserCookies" parameterClass="userCookie" resultClass="userCookie">
    <![CDATA[
        select id, username, cookie_id as cookieId, date_created as dateCreated
        from user_cookie where username = #username# and cookie_id = #cookieId#;
    ]]>
    </select>
    
	<delete id="deleteUserCookies" parameterClass="userCookie">
    <![CDATA[
        delete from user_cookie where username = #username#;
    ]]>
    </delete>
    
	<insert id="addUserCookie" parameterClass="userCookie">
    <![CDATA[
        insert into 
            user_cookie (id, username, cookie_id, date_created)
        values (#id#, #username#, #cookieId#, #dateCreated#);
    ]]>
    </insert>
    
	<select id="getUserCookieId" resultClass="long">
    <![CDATA[
        select max(id) from user_cookie;
    ]]>
    </select>
    
	<update id="updateUserCookie" parameterClass="userCookie">
    <![CDATA[
        update user_cookie SET
            username = #username#,
            cookie_id = #cookieId#,
            date_created = #dateCreated#
        where id = #id#;
    ]]>
    </update>
</sqlMap>
