<!--
   - Resin 3.0 configuration file.
  -->
<resin xmlns="http://caucho.com/ns/resin"
       xmlns:resin="http://caucho.com/ns/resin/core">

  <log name='' level='config' path='stdout:' timestamp='[%H:%M:%S.%s] '/>
  <log name='com.caucho.java' level='fine' path='stdout:'
       timestamp='[%H:%M:%S.%s] '/>
  <log name='com.caucho.loader' level='config' path='stdout:'
       timestamp='[%H:%M:%S.%s] '/>

  <dependency-check-interval>2s</dependency-check-interval>

  <javac compiler="internal" args=""/>

  <thread-pool>
    <!-- Maximum number of threads. -->
    <thread-max>200</thread-max>

    <!-- Minimum number of spare connection threads. -->
    <spare-thread-min>25</spare-thread-min>
  </thread-pool>

  <min-free-memory>1M</min-free-memory>

  <server>
    <!-- adds all .jar files under the resin/lib directory -->
    <class-loader>
      <tree-loader path="$resin-home/lib"/>
    </class-loader>

    <!-- The http port -->
    <http id="" host="*" port="8080"/>

    <cluster>
      <srun id="" host="127.0.0.1" port="6802" index="1"/>
    </cluster>

    <ignore-client-disconnect>true</ignore-client-disconnect>

    <cache path="cache" memory-size="10M"/>

    <web-app-default>
      <cache-mapping url-pattern="/" expires="5s"/>
      <cache-mapping url-pattern="*.gif" expires="60s"/>
      <cache-mapping url-pattern="*.jpg" expires="60s"/>
    </web-app-default>

    <host-default>
      <class-loader>
        <compiling-loader path='webapps/WEB-INF/classes'/>
        <library-loader path='webapps/WEB-INF/lib'/>
      </class-loader>

      <access-log path='logs/access.log' 
            format='%h %l %u %t "%r" %s %b "%{Referer}i" "%{User-Agent}i"'
            rollover-period='1W'/>

      <web-app-deploy path='webapps'/>
      <resource-deploy path='deploy'/>
      <web-app-deploy path='deploy'/>
    </host-default>

    <resin:include path="app-default.xml"/>

    <host id=''>
      <document-directory>doc</document-directory>

      <!-- configures appfuse as a web-app -->
      <web-app id='/appfuse'
        document-directory="webapps/appfuse">
    
        <database>
            <jndi-name>jdbc/appfuse</jndi-name>
            <driver type="com.mysql.jdbc.Driver">
                <url>jdbc:mysql://localhost:3306/appfuse</url>
                <user>test</user>
                <password>test</password>
            </driver>
        </database>
    
        <!-- Resin-specific JdbcAuthenticator -->
        <authenticator type="com.caucho.server.security.JdbcAuthenticator">
            <init>
                <data-source>jdbc/appfuse</data-source>
                <password-query>
                  SELECT password FROM app_user WHERE username=?
                </password-query>
                <role-query>
                  SELECT role_name FROM user_role r, app_user u
                    WHERE r.username=? and r.username = u.username
                </role-query>
                <password-digest>none</password-digest>
            </init>
        </authenticator>
      </web-app>
    </host>
  </server>
</resin>